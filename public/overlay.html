<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Overlay</title>
  <style>
    :root { 
      --STAGE-W: 1920px;  /* por defecto, puedes sobreescribir con ?w */
      --STAGE-H: 1080px;  /* por defecto, puedes sobreescribir con ?h */
    }
    html, body { margin:0; padding:0; overflow:hidden; background:transparent; }
    #stage { position:relative; width:var(--STAGE-W); height:var(--STAGE-H); }
    .item { position:absolute; transform-origin:center center; will-change: transform, opacity; }
    .item.text{
      padding: 6px 10px;
      color:#ffffff;
      background: transparent;     /* Fondo transparente (como pediste) */
      white-space: pre-wrap;
      text-shadow: 0 0 3px rgba(0,0,0,.7);
      line-height: 1.15;
    }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div id="stage"></div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // Permite fijar tamaño exacto desde OBS: /overlay?w=1920&h=1080
    (function applySizeFromQuery(){
      const p = new URLSearchParams(location.search);
      const w = p.get('w'), h = p.get('h');
      if (w) document.documentElement.style.setProperty('--STAGE-W', w.replace('px','') + 'px');
      if (h) document.documentElement.style.setProperty('--STAGE-H', h.replace('px','') + 'px');
    })();

    const stage = document.getElementById('stage');
    const items = new Map();        // id -> elemento DOM
    const lastKnown = new Map();    // id -> snapshot (x,y,scale,rot,opacity,zIndex,visible,muted,loop, text,fontSize,color)

    function getSnapshot(it) {
      return {
        x: it.x || 0,
        y: it.y || 0,
        scale: it.scale || 1,
        rot: it.rot || 0,
        opacity: it.opacity == null ? 1 : it.opacity,
        zIndex: it.zIndex || 1,
        visible: it.visible !== false,
        muted: !!it.muted,
        loop: it.loop !== false, // por defecto true para videos
        text: it.text,
        fontSize: it.fontSize,
        color: it.color
      };
    }

    function mount(item){
      let el;
      if(item.type === 'image'){
        el = document.createElement('img'); el.src = item.url;
      } else if(item.type === 'video'){
        el = document.createElement('video');
        el.src = item.url;
        el.autoplay = true; 
        el.loop = true;           // 🔁 en bucle
        el.muted = !!item.muted; 
        el.playsInline = true; 
        el.controls = false;
      } else if(item.type === 'audio'){
        el = document.createElement('audio');
        el.src = item.url; el.autoplay = true; el.loop = !!item.loop; el.muted = !!item.muted; el.controls = false;
      } else if(item.type === 'text'){
        el = document.createElement('div');
        el.classList.add('text');
        el.textContent = item.text || 'Texto';
        el.style.fontSize = (item.fontSize || 48) + 'px';
        el.style.color = item.color || '#ffffff';
      } else {
        return;
      }
      el.classList.add('item');
      el.dataset.id = item.id;
      stage.appendChild(el);
      items.set(item.id, el);
      const snap = getSnapshot(item);
      lastKnown.set(item.id, snap);
      applyStyles(item.id, snap);
    }

    function applyStyles(id, snap){
      const el = items.get(id); if(!el) return;
      // Propiedades de texto si aplica
      if (el.classList.contains('text')) {
        if (snap.text != null) el.textContent = snap.text;
        if (snap.fontSize != null) el.style.fontSize = snap.fontSize + 'px';
        if (snap.color != null) el.style.color = snap.color;
      }

      el.style.zIndex = String(snap.zIndex);
      el.style.opacity = snap.opacity;
      el.style.transform = `translate3d(${snap.x}px, ${snap.y}px, 0) scale(${snap.scale}) rotate(${snap.rot}deg)`;
      el.classList.toggle('hidden', !snap.visible);
      if (el.tagName === 'VIDEO') {
        el.loop = true;                 // forzar loop
        el.muted = snap.muted;
      }
    }

    function unmount(id){
      const el = items.get(id); if(!el) return;
      el.remove(); items.delete(id); lastKnown.delete(id);
    }

    // ---- INIT Y CAMBIOS PERSISTENTES ----
    socket.on('state:init', (state) => {
      stage.innerHTML = '';
      items.clear(); lastKnown.clear();
      state.forEach(mount);
    });

    socket.on('item:added', (it) => mount(it));

    socket.on('item:updated', ({ id, patch }) => {
      const snap = getSnapshot(patch);
      lastKnown.set(id, snap);
      applyStyles(id, snap);
    });

    socket.on('item:removed', (id) => unmount(id));

    socket.on('items:cleared', () => {
      stage.innerHTML = '';
      items.clear(); lastKnown.clear();
    });

    // ---- PREVIEW EN TIEMPO REAL (NO PERSISTE) ----
    socket.on('item:preview', ({ id, x, y }) => {
      const el = items.get(id); if(!el) return;
      const snap = lastKnown.get(id) || { x:0, y:0, scale:1, rot:0, opacity:1, zIndex:1, visible:true, muted:false, loop:true };
      const temp = { ...snap, x, y };
      applyStyles(id, temp);
    });
  </script>
</body>
</html>
